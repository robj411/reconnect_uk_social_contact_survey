install.packages('flextable')
install.packages('scoringutils')
R profile.site
Rprofile.site
install.packages('"~/Downloads/scoringutils_2.1.0.tgz"')
install.packages("~/Downloads/scoringutils_2.1.0.tgz")
library(scoringutils)
curl::has_internet
if (is.character(getURL("www.google.com"))) {
out <- TRUE
} else {
out <- FALSE
}
Sys.geten()
Sys.getenv()
install.packages('flextable')
library(flextable)
install.packages('flextable')
library(flextable)
.libPaths()
getwd()
install.packages('flextable')
install.packages('flextable', verbose = TRUE)
setInternet2(TRUE)
temp <- tempfile()
download.file("https://files.digital.nhs.uk/49/D6F2CE/child-vaccination-stats-csvs-2023-24.zip",temp)
temp <- tempfile()
download.file("http://files.digital.nhs.uk/49/D6F2CE/child-vaccination-stats-csvs-2023-24.zip",temp)
options(download.file.method="libcurl")
temp <- tempfile()
download.file("https://files.digital.nhs.uk/49/D6F2CE/child-vaccination-stats-csvs-2023-24.zip",temp)
options(repos='http://cran.rstudio.com/')
install.packages('flextable')
options(repos='https://cran.rstudio.com/')
?Startup
options(repos = c(CRAN = "https://cran.ma.imperial.ac.uk/",
CRANextra = "https://mirrors.ebi.ac.uk/CRAN/"))
install.packages("flextable")
options(repos='https://cran.rstudio.com/')
Sys.getenv()
Sys.getenv("R_PROFILE")
c( Sys.getenv("R_PROFILE"),
file.path(Sys.getenv("R_HOME"), "etc", "Rprofile.site"),
Sys.getenv("R_PROFILE_USER"),
file.path(getwd(), ".Rprofile"),
file.path(Sys.getenv("HOME"), ".Rprofile"))
candidates <- c( Sys.getenv("R_PROFILE"),
file.path(Sys.getenv("R_HOME"), "etc", "Rprofile.site"),
Sys.getenv("R_PROFILE_USER"),
file.path(getwd(), ".Rprofile"),
file.path(Sys.getenv("HOME"), ".Rprofile"))
Filter(file.exists, candidates)
file.path(Sys.getenv("HOME"), ".Rprofile")
Sys.getenv("PATH")
library(devtools)
install.libraries('"~/Downloads/devtools_2.4.5.tgz"')
install.packages("~/Downloads/devtools_2.4.5.tgz")
library(devtools)
install.packages("~/Downloads/usethis_3.1.0.tgz")
library(usethis)
lib.loc
.libPaths()
install.packages('flextable')
renv::restore()
install.packages('renv')
library(renvb)
library(renv)
temp <- tempfile()
download.file("https://files.digital.nhs.uk/49/D6F2CE/child-vaccination-stats-csvs-2023-24.zip",temp)
temp <- tempfile()
download.file("https://files.digital.nhs.uk/49/D6F2CE/child-vaccination-stats-csvs-2023-24.zip",temp)
temp <- tempfile()
download.file("https://files.digital.nhs.uk/49/D6F2CE/child-vaccination-stats-csvs-2023-24.zip",temp)
install.packages('renv')
install.packages('renv')
install.packages('renv')
library(renv)
install.packages('renv')
install.packages('renv')
install.packages('renv')
install.packages('renv')
temp <- tempfile()
download.file("https://files.digital.nhs.uk/49/D6F2CE/child-vaccination-stats-csvs-2023-24.zip",temp)
# load packages
library(data.table)
library(readr)
library(readxl)
library(tidyr, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(purrr, warn.conflicts = FALSE)
library(patchwork, warn.conflicts = FALSE)
library(RColorBrewer, warn.conflicts = FALSE)
library(ggplot2)
suppressPackageStartupMessages(library(viridis, warn.conflicts = FALSE))
# set arguments
.args <- if (interactive()) c(
file.path("output", "data", "cont_matrs","fitted_matrs.csv"),
file.path("data", "census","imd_age.csv"),
file.path("output", "figures", "cont_matrs","fitted_matrs.png")
) else commandArgs(trailingOnly = TRUE)
source(here::here('scripts','run_cont_matrs','cont_matr_fcns.R'))
# load packages
library(data.table)
library(readr)
library(readxl)
library(tidyr, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
setwd("~/Desktop/LSHTM/PhD_2528/Reconnect/reconnect_uk_social_contact_survey")
# censor any categories of participant with less than x:
censor_low_val <- 5
# right-censor total contact counts at:
max_n_contacts <- 10000 # deliberately redundant
# choose age groups for analysis
age_breaks <- c(-Inf, 5*1:(75/5), Inf)
age_vals <- age_breaks[is.finite(age_breaks)]
age_labels <- c(paste0(c(0, age_vals[1:length(age_vals)-1]), '-', c(age_vals-1)), paste0(age_vals[length(age_vals)], '+'))
library(here)
## install appropriate packages ##
source(here::here('scripts','analyses','install_packages.R'))
source(here::here('scripts','analyses','colors.R'))
## source analysis functions ##
source(here::here('scripts','analyses','functions.R'))
## negative binomial functions ##
source(here::here('scripts','analyses','negative_binom','negative_binomial_fcns.R'))
## load UK gender-specific age structure etc. ##
source(here::here('scripts','analyses','age_structure.R'))
## load data ##
reconnect_participant_common <- read_csv(here::here('data','zenodo','reconnect_participant_common.csv'), show_col_types = F)
reconnect_participant_extra <- read_csv(here::here('data','zenodo','reconnect_participant_extra.csv'), show_col_types = F)
reconnect_participant_sday <- read_csv(here::here('data','zenodo','reconnect_sday.csv'), show_col_types = F)
reconnect_participant <- left_join(reconnect_participant_common,
reconnect_participant_extra,
by = 'part_id') %>% left_join(reconnect_participant_sday, by = 'part_id')
reconnect_contact_common <- read_csv(here::here('data','zenodo','reconnect_contact_common.csv'), show_col_types = F)
reconnect_contact_extra <- read_csv(here::here('data','zenodo','reconnect_contact_extra.csv'), show_col_types = F)
reconnect_contact <- left_join(reconnect_contact_common,
reconnect_contact_extra,
by = c('cont_id','part_id'))
reconnect_contact
# load age weights for large_n
polymod_wts <- polymod_weights()
part <- reconnect_participant %>%
rename(p_id = part_id,
p_age_group = part_age_group,
p_adult_child = part_adult_child,
p_gender = part_gender,
p_ethnicity = part_ethnicity,
p_sec_input = part_ses) %>%
mutate(p_gender = case_when(p_gender == 'F' ~ 'Female',
p_gender == 'M' ~ 'Male',
T ~ NA))
contacts <- reconnect_contact %>%
rename(c_id = cont_id,
p_id = part_id,
c_location = cnt_location,
c_age_group = cnt_age_group,
c_sex = cnt_gender,
c_ethnicity = cnt_ethnicity,
c_sec_input = cnt_ses) %>%
mutate(c_sex = case_when(c_sex == 'F' ~ 'Female',
c_sex == 'M' ~ 'Male',
T ~ NA))
part
contacts
# if results folder doesn't exist, create
if(!file.exists('results')){dir.create('results')}
nb_age_group <- nb_matrix_fit(
participant_data = part,
contact_data = contacts,
participant_var = "p_age_group",
contact_var = "c_age_group",
n_bootstrap = 1,
trunc = max_n_contacts,
polymod_weighting = polymod_wts,
weighting_vec = c('p_gender','p_ethnicity','day_week'),
locations = c("Total", "Home", "Work", "School", "Other")
)
contacts
contacts$c_age_group
part$p_age_group
nb_age_group <- nb_matrix_fit(
participant_data = part,
contact_data = contacts,
participant_var = "p_age_group",
contact_var = "c_age_group",
n_bootstrap = 1000,
trunc = max_n_contacts,
polymod_weighting = polymod_wts,
weighting_vec = c('p_gender','p_ethnicity','day_week'),
locations = c("Total", "Home", "Work", "School", "Other")
)
participant_data = part
contact_data = contacts
participant_var = "p_age_group"
contact_var = "c_age_group"
n_bootstrap=1
trunc = max_n_contacts
polymod_weighting = polymod_wts
weighting_vec = c('p_gender','p_ethnicity','day_week')
locations = c("Total", "Home", "Work", "School", "Other")
contacts
if(impute_contact & contact_var %notin% c('c_ethnicity','c_sec_input')){stop("Can't impute for this contact variable.")}
weighting_vec <- weighting_vec[weighting_vec %notin% participant_var]
impute_contact = F
impute_vars = NULL
large_n_input = T
age_structure_ac = age_structure_adult_child
age_structure = age_structure_fine
ethnicity_structure = ons_ethnicity
age_structure_gendered = age_sex_strata
if(impute_contact & contact_var %notin% c('c_ethnicity','c_sec_input')){stop("Can't impute for this contact variable.")}
weighting_vec <- weighting_vec[weighting_vec %notin% participant_var]
weighted_all <- if(length(weighting_vec)>=1){
participant_data %>% select(p_id) %>%
left_join(weight_participants(participant_data,
age_structure,
age_structure_gendered,
ethnicity_structure,
age_structure_ac,
weighting = weighting_vec,
group_vars = participant_var) %>%
select(p_id, post_strat_weight),
by = 'p_id')
}else{
participant_data %>% group_by(p_id) %>% summarise(post_strat_weight = 1)
}
if(is.null(contact_var)){
contact_data <- contact_data %>% mutate(c_null = 1)
contact_var <- 'c_null'
}
# summarise contact data
raw_counts_matr <- raw_counts(
part_in = participant_data,
cont_in = contact_data,
participant_var,
contact_var,
large_n_input = large_n_input
)
part_in = participant_data
cont_in = contact_data
participant_var
if(is.null(contact_var)){
cont_in <- cont_in %>% mutate(c_null = 'NULL')
contact_var <- 'c_null'
}
# Determine which variables to select from part_in
select_vars <- unique(c('p_id', participant_var))
if((length(contact_var) == 1 & 'c_age_group' %in% contact_var & large_n_input) |
(length(contact_var) == 1 & 'c_location' %in% contact_var & large_n_input)){
select_vars <- c(select_vars, colnames(part_in)[grepl('add_', colnames(part_in))])
}else{
if(large_n_input & length(contact_var) == 1){
if(contact_var=='c_null'){
select_vars <- c(select_vars, 'large_n')
}
}
}
if(location_inclusion == T){
contact_var_orig <- contact_var
contact_var <- unique(c(contact_var, 'c_location'))
}else{contact_var_orig <- contact_var}
large_n_input = T
location_inclusion = T
if(location_inclusion == T){
contact_var_orig <- contact_var
contact_var <- unique(c(contact_var, 'c_location'))
}else{contact_var_orig <- contact_var}
# in case joining vars (apart from p_id) are in both part_in and cont_in
for(var_i in select_vars[select_vars != 'p_id']){
cont_in <- cont_in %>% select(!starts_with(var_i))
}
# Calculate contacts for each combination and location
contact_counts <- cont_in %>% filter(p_id %in% part_in$p_id) %>%  # in case cont_in/part_in are filtered, e.g. by gender
left_join(part_in %>% filter(p_id %in% cont_in$p_id) %>% select(!!!syms(select_vars)), by = "p_id") %>%
group_by(!!!syms(select_vars), !!!syms(contact_var)) %>%
summarise(n_contacts = n(), .groups = "drop")
# drop any participants which contain any NAs for contact_var
contact_counts <- contact_counts %>% drop_na(!!!syms(contact_var))
# adding back in individuals with 0 contacts
add_data <- part_in %>% filter(p_id %notin% cont_in$p_id) %>% select(!!!syms(select_vars))
names <- colnames(add_data)
for(var in contact_var){
add_data <- add_data %>% mutate(var = unname(unlist(cont_in[1,..var])))
colnames(add_data) <- c(names, var)
names <- colnames(add_data)
}
contact_var
cont_in
# adding back in individuals with 0 contacts
add_data <- part_in %>% filter(p_id %notin% cont_in$p_id) %>% select(!!!syms(select_vars))
names <- colnames(add_data)
add_data
for(var in contact_var){
add_data <- add_data %>% mutate(var = unname(unlist(cont_in[1,..var])))
colnames(add_data) <- c(names, var)
names <- colnames(add_data)
}
var
unname(unlist(cont_in[1,..var]))
cont_in
var
var='c_location'
add_data <- add_data %>% mutate(var = unname(unlist(cont_in[1,..var])))
cont_in[1,..var]
cont_in[1,var]
add_data <- add_data %>% mutate(var = unname(unlist(cont_in[1,var])))
# adding back in individuals with 0 contacts
add_data <- part_in %>% filter(p_id %notin% cont_in$p_id) %>% select(!!!syms(select_vars))
raw_counts <- function(
part_in,
cont_in,
participant_var,
contact_var,
large_n_input = T,
location_inclusion = T
){
if(is.null(contact_var)){
cont_in <- cont_in %>% mutate(c_null = 'NULL')
contact_var <- 'c_null'
}
# Determine which variables to select from part_in
select_vars <- unique(c('p_id', participant_var))
if((length(contact_var) == 1 & 'c_age_group' %in% contact_var & large_n_input) |
(length(contact_var) == 1 & 'c_location' %in% contact_var & large_n_input)){
select_vars <- c(select_vars, colnames(part_in)[grepl('add_', colnames(part_in))])
}else{
if(large_n_input & length(contact_var) == 1){
if(contact_var=='c_null'){
select_vars <- c(select_vars, 'large_n')
}
}
}
if(location_inclusion == T){
contact_var_orig <- contact_var
contact_var <- unique(c(contact_var, 'c_location'))
}else{contact_var_orig <- contact_var}
# in case joining vars (apart from p_id) are in both part_in and cont_in
for(var_i in select_vars[select_vars != 'p_id']){
cont_in <- cont_in %>% select(!starts_with(var_i))
}
# Calculate contacts for each combination and location
contact_counts <- cont_in %>% filter(p_id %in% part_in$p_id) %>%  # in case cont_in/part_in are filtered, e.g. by gender
left_join(part_in %>% filter(p_id %in% cont_in$p_id) %>% select(!!!syms(select_vars)), by = "p_id") %>%
group_by(!!!syms(select_vars), !!!syms(contact_var)) %>%
summarise(n_contacts = n(), .groups = "drop")
# drop any participants which contain any NAs for contact_var
contact_counts <- contact_counts %>% drop_na(!!!syms(contact_var))
# adding back in individuals with 0 contacts
add_data <- part_in %>% filter(p_id %notin% cont_in$p_id) %>% select(!!!syms(select_vars))
names <- colnames(add_data)
for(var in contact_var){
add_data <- add_data %>% mutate(var = unname(unlist(cont_in[1,var])))
colnames(add_data) <- c(names, var)
names <- colnames(add_data)
}
add_data <- add_data %>% mutate(n_contacts = 0)
colnames(add_data) <- c(select_vars, contact_var, 'n_contacts')
contact_counts <- rbind(contact_counts,
add_data) %>%
complete(nesting(!!!syms(select_vars)), !!!syms(contact_var), fill = list(n_contacts = 0))
if(location_inclusion == T){
# Calculate total contacts across all locations
total_contacts <- contact_counts %>%
group_by(!!!syms(select_vars), !!!syms(contact_var[contact_var != 'c_location'])) %>%
summarise(n_contacts = sum(n_contacts), .groups = "drop") %>%
mutate(c_location = "Total")
# Combine location-specific and total contacts
all_contacts <- bind_rows(contact_counts, total_contacts)
}else{
all_contacts <- contact_counts
}
# pivot_wider
all_contacts_w <- all_contacts %>% pivot_wider(
names_from = !!sym(contact_var_orig),
values_from = n_contacts,
names_glue = sprintf('cag_{%s}', contact_var_orig),
) %>% select(!!!syms(select_vars), contains('c_location'), starts_with('cag'), starts_with('add_'))
# set maximum (right-truncation)
all_contacts_w <- all_contacts_w %>%
mutate(across(starts_with('add_'), max_100))
all_contacts_w
}
# summarise contact data
raw_counts_matr <- raw_counts(
part_in = participant_data,
cont_in = contact_data,
participant_var,
contact_var,
large_n_input = large_n_input
)
if(is.null(contact_var)){
cont_in <- cont_in %>% mutate(c_null = 'NULL')
contact_var <- 'c_null'
}
# Determine which variables to select from part_in
select_vars <- unique(c('p_id', participant_var))
if((length(contact_var) == 1 & 'c_age_group' %in% contact_var & large_n_input) |
(length(contact_var) == 1 & 'c_location' %in% contact_var & large_n_input)){
select_vars <- c(select_vars, colnames(part_in)[grepl('add_', colnames(part_in))])
}else{
if(large_n_input & length(contact_var) == 1){
if(contact_var=='c_null'){
select_vars <- c(select_vars, 'large_n')
}
}
}
if(location_inclusion == T){
contact_var_orig <- contact_var
contact_var <- unique(c(contact_var, 'c_location'))
}else{contact_var_orig <- contact_var}
# in case joining vars (apart from p_id) are in both part_in and cont_in
for(var_i in select_vars[select_vars != 'p_id']){
cont_in <- cont_in %>% select(!starts_with(var_i))
}
# Calculate contacts for each combination and location
contact_counts <- cont_in %>% filter(p_id %in% part_in$p_id) %>%  # in case cont_in/part_in are filtered, e.g. by gender
left_join(part_in %>% filter(p_id %in% cont_in$p_id) %>% select(!!!syms(select_vars)), by = "p_id") %>%
group_by(!!!syms(select_vars), !!!syms(contact_var)) %>%
summarise(n_contacts = n(), .groups = "drop")
# drop any participants which contain any NAs for contact_var
contact_counts <- contact_counts %>% drop_na(!!!syms(contact_var))
# adding back in individuals with 0 contacts
add_data <- part_in %>% filter(p_id %notin% cont_in$p_id) %>% select(!!!syms(select_vars))
names <- colnames(add_data)
for(var in contact_var){
add_data <- add_data %>% mutate(var = unname(unlist(cont_in[1,var])))
colnames(add_data) <- c(names, var)
names <- colnames(add_data)
}
add_data <- add_data %>% mutate(n_contacts = 0)
colnames(add_data) <- c(select_vars, contact_var, 'n_contacts')
contact_counts <- rbind(contact_counts,
add_data) %>%
complete(nesting(!!!syms(select_vars)), !!!syms(contact_var), fill = list(n_contacts = 0))
if(location_inclusion == T){
# Calculate total contacts across all locations
total_contacts <- contact_counts %>%
group_by(!!!syms(select_vars), !!!syms(contact_var[contact_var != 'c_location'])) %>%
summarise(n_contacts = sum(n_contacts), .groups = "drop") %>%
mutate(c_location = "Total")
# Combine location-specific and total contacts
all_contacts <- bind_rows(contact_counts, total_contacts)
}else{
all_contacts <- contact_counts
}
# pivot_wider
all_contacts_w <- all_contacts %>% pivot_wider(
names_from = !!sym(contact_var_orig),
values_from = n_contacts,
names_glue = sprintf('cag_{%s}', contact_var_orig),
) %>% select(!!!syms(select_vars), contains('c_location'), starts_with('cag'), starts_with('add_'))
select_vars
contact_var_orig
contact_var_orig
source("~/Desktop/LSHTM/PhD_2528/Reconnect/reconnect_uk_social_contact_survey/scripts/analyses/negative_binom/negative_binomial_fcns.R")
nb_matrix_fit(
participant_data = part,
contact_data = contacts,
participant_var = "p_age_group",
contact_var = "c_age_group",
n_bootstrap = 1,
trunc = max_n_contacts,
polymod_weighting = polymod_wts,
weighting_vec = c('p_gender','p_ethnicity','day_week'),
locations = c("Total", "Home", "Work", "School", "Other")
)
